<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Neuralyzer - Data Viewer Widget</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Neuralyzer</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../examples/keypoint_labeling.html">
 <span class="dropdown-text">Keypoint Labeling</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-how-to-guides" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">How-to guides</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-how-to-guides">    
        <li>
    <a class="dropdown-item" href="../labeling/keypoint.html">
 <span class="dropdown-text">Label Creation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../labeling/mask.html">
 <span class="dropdown-text">Mask Creation</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-reference-guides" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Reference Guides</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-reference-guides">    
        <li>
    <a class="dropdown-item" href="../user_guide/index.html">
 <span class="dropdown-text">User Guide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../developer/index.html">
 <span class="dropdown-text">Developer Guide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../api_reference.html">
 <span class="dropdown-text">API Reference</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/paulmthompson/WhiskerToolbox"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="dropdown-header">
 <span class="menu-text">Concepts</span></li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../developer/data_viewer_widget.html">Data Viewer Widget</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Developer Documentation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/building.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Building</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/code_quality.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Code Quality, Linters, and Analyzers</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/copilot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">C++ Development Tools Reference</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/contributing_code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contributing Code</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api_reference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">API Reference</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/data_manager.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Manager</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/file_io.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">File IO</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/image_processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Image Processing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/media_widget.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Media Widget</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/data_manager_widget.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Manager Widget</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/data_transform_widget.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Transform Widget</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/data_viewer_widget.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Data Viewer Widget</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/table_view.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Table View</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/transforms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">transforms</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../developer/Features/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Features</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developer/Features/Collapsible_Widget.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Collapsible Widget</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-viewer-widget-overview" id="toc-data-viewer-widget-overview" class="nav-link active" data-scroll-target="#data-viewer-widget-overview">Data Viewer Widget Overview</a></li>
  <li><a href="#visualization-capabilities" id="toc-visualization-capabilities" class="nav-link" data-scroll-target="#visualization-capabilities">Visualization Capabilities</a></li>
  <li><a href="#handling-grouped-data-and-custom-arrangement" id="toc-handling-grouped-data-and-custom-arrangement" class="nav-link" data-scroll-target="#handling-grouped-data-and-custom-arrangement">Handling Grouped Data and Custom Arrangement</a></li>
  <li><a href="#interactive-analysis-and-pre-processing" id="toc-interactive-analysis-and-pre-processing" class="nav-link" data-scroll-target="#interactive-analysis-and-pre-processing">Interactive Analysis and Pre-processing</a>
  <ul class="collapse">
  <li><a href="#event-viewer-features" id="toc-event-viewer-features" class="nav-link" data-scroll-target="#event-viewer-features">Event Viewer Features</a>
  <ul class="collapse">
  <li><a href="#display-modes" id="toc-display-modes" class="nav-link" data-scroll-target="#display-modes">Display Modes</a></li>
  <li><a href="#auto-spacing-for-event-groups" id="toc-auto-spacing-for-event-groups" class="nav-link" data-scroll-target="#auto-spacing-for-event-groups">Auto-Spacing for Event Groups</a></li>
  <li><a href="#user-controls" id="toc-user-controls" class="nav-link" data-scroll-target="#user-controls">User Controls</a></li>
  <li><a href="#implementation-details" id="toc-implementation-details" class="nav-link" data-scroll-target="#implementation-details">Implementation Details</a></li>
  <li><a href="#time-frame-synchronization" id="toc-time-frame-synchronization" class="nav-link" data-scroll-target="#time-frame-synchronization">Time Frame Synchronization</a></li>
  </ul></li>
  <li><a href="#interactive-interval-editing" id="toc-interactive-interval-editing" class="nav-link" data-scroll-target="#interactive-interval-editing">Interactive Interval Editing</a>
  <ul class="collapse">
  <li><a href="#interval-selection-and-highlighting" id="toc-interval-selection-and-highlighting" class="nav-link" data-scroll-target="#interval-selection-and-highlighting">Interval Selection and Highlighting</a></li>
  <li><a href="#interval-edge-dragging" id="toc-interval-edge-dragging" class="nav-link" data-scroll-target="#interval-edge-dragging">Interval Edge Dragging</a></li>
  <li><a href="#technical-implementation" id="toc-technical-implementation" class="nav-link" data-scroll-target="#technical-implementation">Technical Implementation</a></li>
  </ul></li>
  <li><a href="#vertical-space-coordination" id="toc-vertical-space-coordination" class="nav-link" data-scroll-target="#vertical-space-coordination">Vertical Space Coordination</a>
  <ul class="collapse">
  <li><a href="#verticalspacemanager" id="toc-verticalspacemanager" class="nav-link" data-scroll-target="#verticalspacemanager">VerticalSpaceManager</a></li>
  <li><a href="#mvp-matrix-architecture" id="toc-mvp-matrix-architecture" class="nav-link" data-scroll-target="#mvp-matrix-architecture">MVP Matrix Architecture</a></li>
  </ul></li>
  <li><a href="#interval-editing-system" id="toc-interval-editing-system" class="nav-link" data-scroll-target="#interval-editing-system">Interval Editing System</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Data Viewer Widget</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="data-viewer-widget-overview" class="level1">
<h1>Data Viewer Widget Overview</h1>
<p>The <strong>data viewer widget</strong> is designed for visualizing plots of <strong>time series data</strong>. It can operate on multiple distinct data types, such as <strong>analog time series</strong>, <strong>interval series</strong>, and <strong>event series</strong>. The widget contains a table of compatible data types and their corresponding keys, which can be selected for display in the viewer. It houses options to enable the visualization of different types and also includes an <strong>OpenGL canvas</strong> responsible for rendering the data according to user specifications.</p>
</section>
<section id="visualization-capabilities" class="level1">
<h1>Visualization Capabilities</h1>
<p>Multiple pieces of data can be drawn on the same canvas. Some data can be drawn in an overlapping manner, or they may be drawn with different axis offsets. Both the Y and X axes are <strong>zoomable</strong>, and data-specific scaling can be applied to the Y-axis to allow data with different magnitudes to be easily visualized simultaneously. Drawing is <strong>synced to the time scroll bar</strong> in the main program, enabling the user to scroll through the plot while concurrently visualizing data in other widgets, such as movies collected at the same time.</p>
<p>Critically, the data viewer has a concept of <strong>different sampling rates</strong> for different data types and accounts for this during drawing. For instance, event data from camera frames sampled at 500 frames per second can be plotted appropriately with electrophysiological data sampled at 30,000 Hertz. A “Time frame concept” within the data manager is responsible for handling these conversions between coordinate systems, and the data viewer is responsible for plotting this data appropriately.</p>
</section>
<section id="handling-grouped-data-and-custom-arrangement" class="level1">
<h1>Handling Grouped Data and Custom Arrangement</h1>
<p>Some temporal data in neuroscience involves the concept of a <strong>group of signals that are collected simultaneously</strong> and would be visualized simultaneously. For instance, 32 channels recorded simultaneously from a silicon probe would be expected to have the same scaling properties and spacing. Consequently, groups of data like this should, by default, have mostly matching configuration options but maintain the ability to be <strong>adjusted individually</strong> as needed. For example, if there are dead channels on a probe, it should be easy for the user to turn these off from the display.</p>
<p>The <strong>arrangement of data</strong> in the viewer is also important. Again, considering a silicon probe, the numerical channel arrangement is often not the same as the spatial channel arrangement, though the user may wish to view this data spatially arranged. The user should be able to <strong>customize this arrangement</strong>.</p>
</section>
<section id="interactive-analysis-and-pre-processing" class="level1">
<h1>Interactive Analysis and Pre-processing</h1>
<p>This representation may provide the user with information useful for certain data pre-processing tasks. For instance, the user may be able to determine a numerical threshold for event detection in a particular channel. Alternatively, in this view, the user may wish to determine the temporal range where it appears some behavior is taking place based on an analog signal change. For example, viewing the whisker angle versus time when zoomed out may be useful to identify times when the animal is whisking versus when it is stationary.</p>
<p>The user may even wish to <strong>interactively define events or intervals</strong> within this viewer window based on the temporal representation of data that would not be so easy to see in other widgets. Consequently, the data viewer is not just passive in its relationship with the data it is displaying but rather facilitates <strong>active engagement</strong>.</p>
<section id="event-viewer-features" class="level2">
<h2 class="anchored" data-anchor-id="event-viewer-features">Event Viewer Features</h2>
<p>The EventViewer_Widget provides controls for digital event series visualization with two main display modes:</p>
<section id="display-modes" class="level3">
<h3 class="anchored" data-anchor-id="display-modes">Display Modes</h3>
<ol type="1">
<li><strong>Stacked Mode (Default)</strong>: Events are positioned in separate horizontal lanes with configurable spacing
<ul>
<li>Each event series gets its own horizontal “lane”</li>
<li>Configurable vertical spacing between lanes</li>
<li>Configurable event line height</li>
<li>Auto-calculation of optimal spacing when event groups are loaded</li>
</ul></li>
<li><strong>Full Canvas Mode</strong>: Events stretch from top to bottom of the entire canvas
<ul>
<li>Original behavior maintained for compatibility</li>
<li>All events span the full height of the display area</li>
</ul></li>
</ol>
</section>
<section id="auto-spacing-for-event-groups" class="level3">
<h3 class="anchored" data-anchor-id="auto-spacing-for-event-groups">Auto-Spacing for Event Groups</h3>
<p>When a tree of digital event series is selected and enabled, the system automatically calculates optimal spacing to fit all events on the canvas:</p>
<ul>
<li>If 40 events are enabled on a 400-pixel tall canvas, each event gets approximately 10 pixels of space</li>
<li>Spacing and height are calculated to ensure visual separation between different event series</li>
<li>Uses 80% of available canvas height, leaving margins at top and bottom</li>
<li>Event height is set to 60% of calculated spacing to prevent overlap</li>
</ul>
</section>
<section id="user-controls" class="level3">
<h3 class="anchored" data-anchor-id="user-controls">User Controls</h3>
<p>The EventViewer_Widget provides: - <strong>Display Mode</strong>: Combo box to switch between Stacked and Full Canvas modes - <strong>Vertical Spacing</strong>: Adjustable spacing between stacked event series (0.01-1.0 normalized units) - <strong>Event Height</strong>: Adjustable height of individual event lines (0.01-0.5 normalized units) - <strong>Color Controls</strong>: Standard color picker for event line colors and transparency</p>
</section>
<section id="implementation-details" class="level3">
<h3 class="anchored" data-anchor-id="implementation-details">Implementation Details</h3>
<ul>
<li>Event stacking uses normalized coordinates for consistent spacing across different canvas sizes</li>
<li>State is preserved when switching between data series</li>
<li>Integration with existing TreeWidgetStateManager for persistence</li>
<li>Optimized rendering with proper OpenGL line thickness and positioning</li>
</ul>
</section>
<section id="time-frame-synchronization" class="level3">
<h3 class="anchored" data-anchor-id="time-frame-synchronization">Time Frame Synchronization</h3>
<p>The DataViewer Widget properly handles multi-rate data synchronization:</p>
<ul>
<li><strong>Master Time Frame</strong>: OpenGLWidget maintains a reference to the master time frame (“master” or “time”) used for X-axis coordinates</li>
<li><strong>Time Frame Conversion</strong>: When data series use different time frames from the master, proper coordinate conversion ensures synchronized display</li>
<li><strong>Cross-Rate Compatibility</strong>: Supports simultaneous visualization of data collected at different sampling rates (e.g., 30kHz electrophysiology with 500Hz video)</li>
<li><strong>Consistent X-Axis</strong>: All data types (analog time series, digital events, digital intervals) are rendered with consistent X-axis positioning regardless of their native time frame</li>
<li><strong>Range Query Optimization</strong>: Data range queries are optimized for each time frame to ensure efficient rendering of large datasets</li>
</ul>
</section>
</section>
<section id="interactive-interval-editing" class="level2">
<h2 class="anchored" data-anchor-id="interactive-interval-editing">Interactive Interval Editing</h2>
<p>The DataViewer Widget supports interactive editing of digital interval series through a mouse-based dragging interface that handles multi-timeframe data seamlessly.</p>
<section id="interval-selection-and-highlighting" class="level3">
<h3 class="anchored" data-anchor-id="interval-selection-and-highlighting">Interval Selection and Highlighting</h3>
<ul>
<li><strong>Click-to-Select</strong>: Users can click on digital intervals to select them for editing</li>
<li><strong>Visual Feedback</strong>: Selected intervals are highlighted with enhanced borders for clear identification</li>
<li><strong>Per-Series Selection</strong>: Each digital interval series maintains its own independent selection state</li>
</ul>
</section>
<section id="interval-edge-dragging" class="level3">
<h3 class="anchored" data-anchor-id="interval-edge-dragging">Interval Edge Dragging</h3>
<p>The widget provides precise interval boundary editing through a sophisticated dragging system:</p>
<section id="core-functionality" class="level4">
<h4 class="anchored" data-anchor-id="core-functionality">Core Functionality</h4>
<ul>
<li><strong>Edge Detection</strong>: Mouse hover near interval boundaries (within 10 pixels) changes cursor to resize indicator</li>
<li><strong>Drag Initiation</strong>: Click and drag on interval edges to modify interval start or end times</li>
<li><strong>Real-time Preview</strong>: During dragging, both original (dimmed) and new (semi-transparent) interval positions are shown</li>
<li><strong>Collision Prevention</strong>: Automatic constraint enforcement prevents intervals from overlapping with existing intervals</li>
</ul>
</section>
<section id="multi-timeframe-support" class="level4">
<h4 class="anchored" data-anchor-id="multi-timeframe-support">Multi-Timeframe Support</h4>
<p>The interval dragging system automatically handles time frame conversion for data collected at different sampling rates:</p>
<ul>
<li><strong>Coordinate Conversion</strong>: Mouse coordinates (in master time frame) are automatically converted to the series’ native time frame indices</li>
<li><strong>Precision Handling</strong>: Dragged positions are rounded to the nearest valid index in the target time frame, accommodating different sampling resolutions</li>
<li><strong>Constraint Enforcement</strong>: Collision detection and boundary constraints are performed in the series’ native time frame for accuracy</li>
<li><strong>Display Consistency</strong>: Visual feedback remains in master time frame coordinates for consistent user experience</li>
</ul>
</section>
<section id="error-handling-and-robustness" class="level4">
<h4 class="anchored" data-anchor-id="error-handling-and-robustness">Error Handling and Robustness</h4>
<ul>
<li><strong>Graceful Degradation</strong>: Failed time frame conversions abort the drag operation while preserving original data</li>
<li><strong>Data Integrity</strong>: Invalid interval bounds (e.g., start ≥ end) are rejected without modifying existing data</li>
<li><strong>State Management</strong>: Drag operations can be cancelled (ESC key) to restore original interval boundaries</li>
</ul>
</section>
<section id="example-use-cases" class="level4">
<h4 class="anchored" data-anchor-id="example-use-cases">Example Use Cases</h4>
<ol type="1">
<li><strong>Behavioral Annotation</strong>: Researchers can precisely adjust behavioral event boundaries recorded at video frame rates (30-120 Hz) while viewing synchronized neural data at higher sampling rates (20-30 kHz)</li>
<li><strong>Event Refinement</strong>: Fine-tune automatically detected events by dragging boundaries to match observed signal characteristics across different data modalities</li>
<li><strong>Cross-Modal Synchronization</strong>: Align interval boundaries across different measurement systems with varying temporal resolutions</li>
</ol>
</section>
</section>
<section id="technical-implementation" class="level3">
<h3 class="anchored" data-anchor-id="technical-implementation">Technical Implementation</h3>
<p>The interval editing system leverages the existing TimeFrame infrastructure:</p>
<ul>
<li><strong>TimeFrame.getIndexAtTime()</strong>: Converts master time coordinates to series-specific indices</li>
<li><strong>TimeFrame.getTimeAtIndex()</strong>: Converts series indices back to master time coordinates for display</li>
<li><strong>Automatic Snapping</strong>: Ensures all interval boundaries align with valid time points in the target series</li>
<li><strong>Thread Safety</strong>: All operations maintain data consistency during concurrent access</li>
</ul>
<p>This functionality enables precise temporal analysis workflows while abstracting away the complexity of multi-rate data synchronization from the end user.</p>
</section>
</section>
<section id="vertical-space-coordination" class="level2">
<h2 class="anchored" data-anchor-id="vertical-space-coordination">Vertical Space Coordination</h2>
<p>The DataViewer_Widget includes a sophisticated vertical space management system that prevents overlap between different data types and ensures optimal use of screen real estate.</p>
<section id="verticalspacemanager" class="level3">
<h3 class="anchored" data-anchor-id="verticalspacemanager">VerticalSpaceManager</h3>
<p>The <code>VerticalSpaceManager</code> class handles automatic positioning and scaling for all data series:</p>
<ul>
<li><strong>Order-preserving</strong>: New data positioned below existing data</li>
<li><strong>Type-aware spacing</strong>: Different configurations for analog (larger heights), digital events (compact), and intervals (moderate)</li>
<li><strong>Auto-redistribution</strong>: Adding new series triggers recalculation to prevent overlap</li>
<li><strong>Canvas-independent</strong>: Uses normalized coordinates for flexibility</li>
</ul>
</section>
<section id="mvp-matrix-architecture" class="level3">
<h3 class="anchored" data-anchor-id="mvp-matrix-architecture">MVP Matrix Architecture</h3>
<p>The rendering system uses a systematic Model-View-Projection (MVP) matrix approach for consistent positioning and scaling across all data types:</p>
<section id="model-matrix---series-specific-transforms" class="level4">
<h4 class="anchored" data-anchor-id="model-matrix---series-specific-transforms"><strong>Model Matrix</strong> - Series-Specific Transforms</h4>
<p>Handles individual series positioning and scaling:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// For VerticalSpaceManager-positioned series:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>Model <span class="op">=</span> glm<span class="op">::</span>translate<span class="op">(</span>Model<span class="op">,</span> glm<span class="op">::</span>vec3<span class="op">(</span><span class="dv">0</span><span class="op">,</span> series_center_y<span class="op">,</span> <span class="dv">0</span><span class="op">));</span>  <span class="co">// Position</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>Model <span class="op">=</span> glm<span class="op">::</span>scale<span class="op">(</span>Model<span class="op">,</span> glm<span class="op">::</span>vec3<span class="op">(</span><span class="dv">1</span><span class="op">,</span> series_height <span class="op">*</span> <span class="fl">0.5</span><span class="bu">f</span><span class="op">,</span> <span class="dv">1</span><span class="op">));</span> <span class="co">// Scale</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">// For analog series, additional amplitude scaling:</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> amplitude_scale <span class="op">=</span> <span class="fl">1.0</span><span class="bu">f</span> <span class="op">/</span> <span class="op">(</span>stdDev <span class="op">*</span> scale_factor<span class="op">);</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>Model <span class="op">=</span> glm<span class="op">::</span>scale<span class="op">(</span>Model<span class="op">,</span> glm<span class="op">::</span>vec3<span class="op">(</span><span class="dv">1</span><span class="op">,</span> amplitude_scale<span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="view-matrix---global-operations" class="level4">
<h4 class="anchored" data-anchor-id="view-matrix---global-operations"><strong>View Matrix</strong> - Global Operations</h4>
<p>Handles operations applied to all series equally:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>View <span class="op">=</span> glm<span class="op">::</span>translate<span class="op">(</span>View<span class="op">,</span> glm<span class="op">::</span>vec3<span class="op">(</span><span class="dv">0</span><span class="op">,</span> _verticalPanOffset<span class="op">,</span> <span class="dv">0</span><span class="op">));</span> <span class="co">// Global panning</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="projection-matrix---coordinate-system-mapping" class="level4">
<h4 class="anchored" data-anchor-id="projection-matrix---coordinate-system-mapping"><strong>Projection Matrix</strong> - Coordinate System Mapping</h4>
<p>Maps world coordinates to screen coordinates:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// X axis: time range [start_time, end_time] → screen width</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Y axis: world coordinates [min_y, max_y] → screen height</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>Projection <span class="op">=</span> glm<span class="op">::</span>ortho<span class="op">(</span>start_time<span class="op">,</span> end_time<span class="op">,</span> min_y<span class="op">,</span> max_y<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="vertex-coordinate-systems" class="level4">
<h4 class="anchored" data-anchor-id="vertex-coordinate-systems">Vertex Coordinate Systems</h4>
<p><strong>VerticalSpaceManager Mode</strong> (recommended): - Vertices use normalized coordinates (-1 to +1 in local space) - Model matrix handles all positioning and scaling - Consistent across all data types</p>
<p><strong>Legacy Mode</strong> (backward compatibility): - Vertices use world coordinates directly - Positioning handled by coordinate calculations - Index-based spacing for events</p>
</section>
<section id="detection-of-positioning-mode" class="level4">
<h4 class="anchored" data-anchor-id="detection-of-positioning-mode">Detection of Positioning Mode</h4>
<p>The system automatically detects which positioning mode to use:</p>
<ul>
<li><strong>Digital Events</strong>: <code>vertical_spacing == 0.0f</code> signals VerticalSpaceManager mode</li>
<li><strong>Analog Series</strong>: <code>y_offset != 0.0f</code> signals VerticalSpaceManager mode<br>
</li>
<li><strong>Digital Intervals</strong>: <code>y_offset != 0.0f</code> signals VerticalSpaceManager mode</li>
</ul>
<p>This ensures backward compatibility while enabling the new systematic approach.</p>
</section>
</section>
</section>
<section id="interval-editing-system" class="level2">
<h2 class="anchored" data-anchor-id="interval-editing-system">Interval Editing System</h2>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>